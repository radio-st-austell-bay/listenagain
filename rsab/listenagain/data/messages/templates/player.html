<html>
  <head>
    <title>RSAB: Listen Again</title>
    <link type="text/css" href="/skin/jplayer.blue.monday.css" rel="stylesheet" />
    <link type="text/css" href="/css/listenagain.css" rel="stylesheet" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
    <script type="text/javascript" src="/js/jquery.jplayer.min.js"></script>

    <script type="text/javascript">
      $(document).ready(function(){
        $("#jquery_jplayer_rsab").jPlayer({
          ready: rsab_process_query_parameters,
          ended: function () {
              $('#rsab-playlist tr.rsab-playlist-item-playing').removeClass('rsab-playlist-item-playing')
          },
          cssSelectorAncestor: "#jp_interface_rsab",
          swfPath: "/js",
          supplied: "mp3"
        });
        $.jPlayer.timeFormat.showHour = true

        $("#rsab-playlist tr.rsab-playlist-item").click(function () {
            var row = $(this).closest('tr.rsab-playlist-item')
            var filepath = row.find('input[name="src"]').val()
            var ext = filepath.split('.').pop()
            var media = {}
            media[ext] = filepath
            $("#jquery_jplayer_rsab").jPlayer("setMedia", media).jPlayer("play")
            $("#jp_playlist_rsab").text($('.rsab-playlist-item-title', this).text())
            row.closest('table').find('.rsab-playlist-item-playing').removeClass('rsab-playlist-item-playing')
            row.addClass('rsab-playlist-item-playing')
        })

        function rsab_process_query_parameters() {
            var query_parameters = window.location.search.replace('?', '').split('&')
            for(i=0; i<query_parameters.length; i++) {
                parameter = query_parameters[i]
                if(parameter == '') {
                    continue
                }
                pos = parameter.indexOf('=')
                if(pos == -1) {
                    key = parameter
                    value = ''
                }
                else {
                    key = parameter.slice(0, pos)
                    value = parameter.slice(pos + 1)
                }
                if(key == 'play') {
                    matches = $('#rsab-playlist tr.rsab-playlist-item input[name=src][value^="/audio/' + value + '"]')
                    if(!matches.length) {
                        matches = $('#rsab-playlist tr.rsab-playlist-item input[name=src][value*="' + value + '"]')
                    }
                    if(matches.length) {
                        matches.first().closest('tr.rsab-playlist-item').click()
                    }
                }
            }
          }
      });
    </script>

  </head>
  <body>

    <div id="jquery_jplayer_rsab" class="jp-jplayer"></div>
    <div class="jp-audio">
      <div class="jp-type-single">
        <div id="jp_interface_rsab" class="jp-interface">
          <ul class="jp-controls">
            <li><a href="#" class="jp-play" tabindex="1">play</a></li>
            <li><a href="#" class="jp-pause" tabindex="1">pause</a></li>
            <li><a href="#" class="jp-stop" tabindex="1">stop</a></li>
            <li><a href="#" class="jp-mute" tabindex="1">mute</a></li>
            <li><a href="#" class="jp-unmute" tabindex="1">unmute</a></li>
          </ul>
          <div class="jp-progress">
            <div class="jp-seek-bar">
              <div class="jp-play-bar"></div>
            </div>
          </div>
          <div class="jp-volume-bar">
            <div class="jp-volume-bar-value"></div>
          </div>
          <div class="jp-current-time"></div>
          <div class="jp-duration"></div>
        </div>
        <div id="jp_playlist_rsab" class="jp-playlist">
        (nothing loaded)
        </div>
      </div>
    </div>

  <table id="rsab-playlist">
    <tr class="rsab-playlist-heading">
      <th>Date/Time</th>
      <th>Show</th>
      <th>Duration</th>
    </tr>
%(playlist_items)s
  </table>

  </body>
</html>
